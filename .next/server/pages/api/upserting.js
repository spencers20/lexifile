"use strict";(()=>{var e={};e.id=514,e.ids=[514],e.modules={416:e=>{e.exports=require("pdf-parse")},666:e=>{e.exports=require("cookie")},3480:(e,t,n)=>{e.exports=n(5600)},4469:e=>{e.exports=require("dotenv/config")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6038:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>l,default:()=>u,routeModule:()=>p});var a=n(3480),i=n(8667),o=n(6435),s=n(8216),c=e([s]);s=(c.then?(await c)():c)[0];let u=(0,o.M)(s,"default"),l=(0,o.M)(s,"config"),p=new a.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/upserting",pathname:"/api/upserting",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},6869:e=>{e.exports=require("cohere-ai")},7313:e=>{e.exports=import("formidable")},7393:e=>{e.exports=require("mammoth")},7895:e=>{e.exports=import("langchain/text_splitter")},8216:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>w,default:()=>A});var a=n(7313),i=n(7393),o=n.n(i),s=n(416),c=n.n(s),u=n(9021),l=n.n(u),p=n(7895),d=n(9661),f=n(6869);n(4469);var m=n(9367),g=n(666),h=e([a,p,d]);[a,p,d]=h.then?(await h)():h;let v=new m.Pinecone({apiKey:process.env.PINECONE_API}).index(process.env.INDEX_NAME,process.env.INDEX_HOST),E=new f.CohereClient({token:process.env.COHERE_API}),w={api:{bodyParser:!1}};async function x(e,t){let n=e.filepath,r="";if("pdf"===t){let e=l().readFileSync(n);r=(await c()(e)).text}else if("txt"===t)r=l().readFileSync(n,"utf-8");else if("docx"===t){let e=l().readFileSync(n);r=(await o().extractRawText({buffer:e})).value}else throw Error("unsupported file ");return{text:r}}async function P(e,t){try{let n=new p.RecursiveCharacterTextSplitter({chunkSize:1800,chunkOverlap:200,lengthFunction:e=>e.split(/\s+/).length}),r=[new d.Document({pageContent:e,metadata:{source:t}})];return{allchunks:await n.splitDocuments(r)}}catch(e){return console.log("error in chunking the documents"),{allchunks:[]}}}async function y(e){try{let t=e.map(e=>e.pageContent),n=await E.v2.embed({texts:t,model:"embed-english-v3.0",inputType:"search_document",embeddingTypes:["float"]});return{embeddings:n.embeddings?.float??[]}}catch(e){return console.log("errror in chunking the data",e),{embeddings:[]}}}async function A(e,t){if("POST"!==e.method)return t.status(400).json({error:"wrong  request made"});(0,a.default)({keepExtensions:!0}).parse(e,async(e,n,r)=>{try{if(e)return t.status(500).json({error:"an error occured in parsing the files"});let n=r.Document||void 0,a=Array.isArray(n)?n[0]:n;if(!a)return console.log("no file detected"),t.status(400).json({error:"no file detected please upload"});let i=a.originalFilename??"",o=i.split(".").pop()?.toLowerCase();if(!o)throw Error("File extension is missing or invalid.");let{text:s}=await x(a,o),{allchunks:c}=await P(s,i),{embeddings:u}=await y(c),l=function(e,t){try{let n=[],r=t.map(e=>e.pageContent);return e.forEach((e,t)=>{let a=r[t],i={id:String(t),values:e,metadata:{text:a,chunk_index:t}};n.push(i)}),n}catch(e){return console.log("error in preparing the upserting document"),[]}}(u,c),p=function(){let e=crypto.randomUUID().replace(/-/g,"").slice(0,8);return`lexi-${e}`}();console.log("namespace",p);let d=await v.namespace(p).upsert(l);t.setHeader("Set-Cookie",(0,g.serialize)("namespace",p,{path:"/",httpOnly:!0,sameSite:"lax",maxAge:300})),t.status(200).json({success:`success in upserting doc ${d}`})}catch(e){console.log("error in parsing / upserting data",e)}})}r()}catch(e){r(e)}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return n}});var n=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9021:e=>{e.exports=require("fs")},9367:e=>{e.exports=require("@pinecone-database/pinecone")},9661:e=>{e.exports=import("langchain/document")}};var t=require("../../webpack-api-runtime.js");t.C(e);var n=t(t.s=6038);module.exports=n})();